name: AgentReg Regression (PR/Daily)

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  schedule:
    # Daily 09:00 JST â‰’ 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      cases_file:
        description: 'CSV path for regression cases'
        required: false
        default: 'cases/agent_regression.csv'
      log_dir:
        description: 'JSONL log directory'
        required: false
        default: 'runs/agentreg'
      report_days:
        description: 'Days for report window'
        required: false
        default: '7'
      baseline_days:
        description: 'Baseline days (previous window)'
        required: false
        default: '7'

permissions:
  contents: read

# ------------------------------------------------------------------
# Common env shared by all steps
# ------------------------------------------------------------------
env:
  CASES_FILE: ${{ github.event.inputs.cases_file || 'cases/agent_regression.csv' }}
  LOG_DIR: ${{ github.event.inputs.log_dir || 'runs/agentreg' }}
  BASELINE_ARTIFACT: agentreg-baseline

jobs:
  # ================================================================
  # 1. Run regression tests (shared by all triggers)
  # ================================================================
  agentreg:
    name: Run AgentReg
    runs-on: ubuntu-latest
    outputs:
      run_id: ${{ steps.runid.outputs.run_id }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Generate run_id
        id: runid
        run: |
          RUN_ID="$(python -c 'import uuid; print(uuid.uuid4())')"
          echo "RUN_ID=$RUN_ID" >> "$GITHUB_ENV"
          echo "run_id=$RUN_ID" >> "$GITHUB_OUTPUT"

      - name: Run regression (JSONL append)
        run: |
          mkdir -p "$LOG_DIR"
          python -m agentops run-daily "$CASES_FILE" \
            --log-dir "$LOG_DIR" --run-id "$RUN_ID" -v || true

      - name: Generate report (Markdown)
        if: always()
        run: |
          DAYS="${{ github.event.inputs.report_days || '7' }}"
          BASELINE_DAYS="${{ github.event.inputs.baseline_days || '7' }}"
          mkdir -p reports
          python -m agentops report \
            --log-dir "$LOG_DIR" --days "$DAYS" --baseline-days "$BASELINE_DAYS" \
            -o "reports/regression_${GITHUB_SHA}.md" -v || true

      # -- Upload JSONL + report as the per-run artifact ---------------
      - name: Upload artifacts (JSONL + report)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: agentreg-run-${{ steps.runid.outputs.run_id }}
          path: |
            runs/**
            reports/**
          retention-days: 30

      # -- Download baseline from main (PR only) -----------------------
      - name: Download baseline artifact (PR only)
        if: github.event_name == 'pull_request'
        uses: dawidd6/action-download-artifact@v6
        with:
          name: ${{ env.BASELINE_ARTIFACT }}
          workflow: regression.yml
          branch: main
          path: baseline
          if_no_artifact_found: warn
        continue-on-error: true

      # -- Gate: check thresholds (S1 + overall) -----------------------
      - name: Gate check
        run: |
          BASELINE_DAYS="${{ github.event.inputs.baseline_days || '7' }}"

          # If baseline directory exists (downloaded artifact), use it
          if [ -d "baseline/runs/agentreg" ] && [ "$(ls -A baseline/runs/agentreg/*.jsonl 2>/dev/null)" ]; then
            echo "ðŸ“¦ Using baseline from main artifact"
            BASELINE_FLAG="--baseline-dir baseline/runs/agentreg"
          else
            echo "ðŸ“… Using trailing ${BASELINE_DAYS}-day window as baseline"
            BASELINE_FLAG="--baseline-days ${BASELINE_DAYS}"
          fi

          python -m agentops check \
            --log-dir "$LOG_DIR" \
            --days 1 \
            ${BASELINE_FLAG} \
            --s1-threshold 100 \
            --overall-threshold 80 \
            --write-summary -v

      # -- Upload baseline snapshot (main only) ------------------------
      #    PRs compare against this artifact.
      - name: Upload baseline snapshot (main)
        if: github.ref == 'refs/heads/main' && success()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BASELINE_ARTIFACT }}
          path: runs/**
          retention-days: 90
          overwrite: true
